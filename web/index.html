<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <title>Steam 游玩区间分析</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React / ReactDOM via UMD + Babel（在浏览器里直接跑 JSX） -->
    <script
      src="https://unpkg.com/react@18/umd/react.development.js"
      crossorigin
    ></script>
    <script
      src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"
      crossorigin
    ></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        margin: 0;
        min-height: 100vh;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #e5e7eb;
        background: radial-gradient(circle at top, #020617 0, #020617 40%, #0b1120 100%);
      }
      .glass-nav {
        backdrop-filter: blur(12px) saturate(1.2);
        background: linear-gradient(
          120deg,
          rgba(15, 23, 42, 0.9),
          rgba(15, 23, 42, 0.6)
        );
        border-bottom: 1px solid rgba(56, 189, 248, 0.5);
        box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.25),
          0 0 32px rgba(59, 130, 246, 0.35);
      }
      .card-hover {
        transition: transform 0.15s ease-out, box-shadow 0.15s ease-out,
          background-color 0.15s ease-out;
      }
      .card-hover:hover {
        transform: translateY(-6px) scale(1.04);
        box-shadow:
          0 18px 45px rgba(59, 130, 246, 0.4),
          0 0 0 1px rgba(56, 189, 248, 0.35);
      }
      .magnetic-shell {
        position: relative;
        isolation: isolate;
      }
      .magnetic-shell::before {
        content: "";
        position: absolute;
        inset: -4px;
        border-radius: 999px;
        padding: 2px;
        background: conic-gradient(
          from 0deg,
          rgba(56, 189, 248, 0.1),
          rgba(251, 113, 133, 0.7),
          rgba(129, 140, 248, 0.9),
          rgba(56, 189, 248, 0.1)
        );
        -webkit-mask:
          linear-gradient(#000 0 0) content-box,
          linear-gradient(#000 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        animation: border-spin 4s linear infinite;
        opacity: 0.9;
      }
      .magnetic-shell::after {
        content: "";
        position: absolute;
        inset: -18px;
        border-radius: 999px;
        background: radial-gradient(
          circle,
          rgba(56, 189, 248, 0.3),
          transparent 60%
        );
        filter: blur(16px);
        opacity: 0.7;
        z-index: -1;
      }
      @keyframes border-spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      const API_BASE = window.location.origin;

      async function fetchJson(path, params) {
        const url = new URL(path, API_BASE);
        if (params) {
          Object.entries(params).forEach(([k, v]) =>
            url.searchParams.set(k, v)
          );
        }
        const res = await fetch(url.toString());
        if (!res.ok) throw new Error("请求失败: " + res.status);
        return res.json();
      }

      const cardVariants = {
        hidden: { opacity: 0, y: 20 },
        visible: {
          opacity: 1,
          y: 0,
          transition: {
            duration: 0.48,
            ease: [0.19, 1, 0.22, 1],
          },
        },
      };

      const containerVariants = {
        hidden: {},
        visible: {
          transition: {
            staggerChildren: 0.06,
          },
        },
      };

      function useScrollNav() {
        const [scrolled, setScrolled] = useState(false);
        useEffect(() => {
          function onScroll() {
            setScrolled(window.scrollY > 80);
          }
          onScroll();
          window.addEventListener("scroll", onScroll);
          return () => window.removeEventListener("scroll", onScroll);
        }, []);
        return scrolled;
      }

      function MagneticButton({ children }) {
        const [pos, setPos] = useState({ x: 0, y: 0 });
        const [active, setActive] = useState(false);

        function handleMove(e) {
          const rect = e.currentTarget.getBoundingClientRect();
          const x = e.clientX - (rect.left + rect.width / 2);
          const y = e.clientY - (rect.top + rect.height / 2);
          const dist = Math.sqrt(x * x + y * y);
          const radius = 120;
          if (dist < radius) {
            const maxOffset = 12;
            const factor = (radius - dist) / radius;
            const nx = (x / (dist || 1)) * maxOffset * factor;
            const ny = (y / (dist || 1)) * maxOffset * factor;
            setPos({ x: nx, y: ny });
            setActive(true);
          } else {
            setPos({ x: 0, y: 0 });
            setActive(false);
          }
        }

        function reset() {
          setPos({ x: 0, y: 0 });
          setActive(false);
        }

        return (
          <button
            className="magnetic-shell relative inline-flex items-center justify-center px-9 py-3 rounded-full bg-gradient-to-r from-violet-700 via-purple-500 to-cyan-400 text-slate-50 text-sm font-semibold shadow-lg shadow-cyan-500/40 border border-cyan-200/40"
            onMouseMove={handleMove}
            onMouseLeave={reset}
            style={{
              transformOrigin: "center",
              transform: `translate(${pos.x}px, ${pos.y}px) scale(${
                active ? 1.03 : 1
              }) rotate(${active ? 2 : 0}deg)`,
              transition: "transform 0.18s cubic-bezier(0.17, 0.67, 0.35, 1.25)",
            }}
          >
            <span className="relative z-10 flex items-center gap-2">
              {children}
            </span>
          </button>
        );
      }

      function aggregateByGame(sessions) {
        const map = new Map();
        sessions.forEach((s) => {
          const key = String(s.appid) + "|" + (s.game_name || "");
          map.set(key, (map.get(key) || 0) + s.minutes_delta);
        });
        return Array.from(map.entries())
          .map(([key, minutes]) => {
            const [appid, name] = key.split("|");
            return { appid, game_name: name, minutes };
          })
          .sort((a, b) => b.minutes - a.minutes);
      }

      function aggregateByDay(sessions) {
        const map = new Map();
        sessions.forEach((s) => {
          const d = new Date(s.window_start_utc);
          const key = d.toISOString().slice(0, 10);
          map.set(key, (map.get(key) || 0) + s.minutes_delta);
        });
        return Array.from(map.entries())
          .map(([day, minutes]) => ({ day, minutes }))
          .sort((a, b) => (a.day < b.day ? -1 : 1));
      }

      function GameBars({ sessions }) {
        const data = useMemo(() => aggregateByGame(sessions), [sessions]);
        if (!data.length)
          return (
            <p className="text-xs text-slate-400">
              当前玩家尚无推断出的游玩数据。
            </p>
          );
        const max = Math.max(...data.map((d) => d.minutes));
        return (
          <div className="space-y-2">
            {data.map((d) => (
              <div key={d.appid + d.game_name} className="flex items-center gap-3">
                <div className="min-w-0 flex-1">
                  <div className="flex items-center gap-2 text-xs text-slate-200">
                    <span className="inline-flex items-center justify-center rounded-full bg-sky-500/20 text-sky-300 px-2 py-0.5">
                      {d.appid}
                    </span>
                    <span className="truncate">{d.game_name || "未知游戏"}</span>
                  </div>
                  <div className="mt-1 h-2 rounded-full bg-slate-900 overflow-hidden">
                    <div
                      className="h-full bg-gradient-to-r from-sky-400 via-cyan-300 to-emerald-300"
                      style={{ width: `${(d.minutes / max) * 100}%` }}
                    ></div>
                  </div>
                </div>
                <div className="w-16 text-right text-[11px] text-slate-400">
                  {d.minutes} 分钟
                </div>
              </div>
            ))}
          </div>
        );
      }

      function DayBars({ sessions }) {
        const data = useMemo(() => aggregateByDay(sessions), [sessions]);
        if (!data.length) return null;
        const max = Math.max(...data.map((d) => d.minutes));
        return (
          <div className="flex gap-1 items-end h-24">
            {data.map((d) => (
              <div key={d.day} className="flex-1 flex flex-col items-center gap-1">
                <div
                  className="w-full rounded-t-md bg-indigo-400/80"
                  style={{
                    height: `${(d.minutes / max) * 100}%`,
                    boxShadow: "0 12px 24px rgba(129, 140, 248, 0.6)",
                  }}
                ></div>
                <div className="text-[10px] text-slate-400">
                  {d.day.slice(5)}
                </div>
              </div>
            ))}
          </div>
        );
      }

      function UserSection({ steamid, sessions }) {
        const totalMinutes = sessions.reduce(
          (sum, s) => sum + s.minutes_delta,
          0
        );
        return (
          <section className="py-10">
            <div className="max-w-6xl mx-auto px-4">
              <div className="flex items-end justify-between gap-4 mb-6">
                <div>
                  <h2 className="text-lg md:text-xl font-semibold text-slate-50">
                    玩家 {steamid}
                  </h2>
                  <p className="text-xs text-slate-400 mt-1">
                    通过多次快照之间的时长跳变推断出的游玩窗口。
                  </p>
                </div>
                <div className="text-right">
                  <div className="text-[10px] text-slate-400">累计推断时长</div>
                  <div className="text-lg font-semibold text-cyan-300">
                    {totalMinutes} 分钟
                  </div>
                </div>
              </div>

              <div
                className="grid grid-cols-1 md:grid-cols-3 gap-4"
              >
                <div
                  className="card-hover rounded-2xl border border-slate-700/70 bg-slate-950/80 p-4 flex flex-col"
                >
                  <h3 className="text-sm font-medium text-slate-50 mb-2">
                    游戏热度
                  </h3>
                  <p className="text-[11px] text-slate-400 mb-3">
                    按游戏聚合推断时长，越长代表近期玩得越多。
                  </p>
                  <GameBars sessions={sessions} />
                </div>

                <div
                  className="card-hover rounded-2xl border border-slate-700/70 bg-slate-950/80 p-4 flex flex-col"
                >
                  <h3 className="text-sm font-medium text-slate-50 mb-2">
                    日期分布
                  </h3>
                  <p className="text-[11px] text-slate-400 mb-3">
                    每天的整体活跃程度，柱子越高代表那天玩得越多。
                  </p>
                  <DayBars sessions={sessions} />
                </div>

                <div
                  className="card-hover rounded-2xl border border-slate-700/70 bg-slate-950/80 p-4 flex flex-col"
                >
                  <h3 className="text-sm font-medium text-slate-50 mb-2">
                    最近窗口
                  </h3>
                  <p className="text-[11px] text-slate-400 mb-3">
                    最近若干条推断 session，按开始时间排序。
                  </p>
                  <div className="space-y-2 overflow-y-auto max-h-60 pr-1">
                    {sessions.slice(-20).map((s, idx) => {
                      const start = new Date(s.window_start_utc);
                      const end = new Date(s.window_end_utc);
                      return (
                        <div
                          key={idx}
                          className="rounded-xl border border-slate-700/70 bg-slate-900/80 px-3 py-2 text-[11px] text-slate-300"
                        >
                          <div className="flex items-center justify-between gap-2">
                            <div className="truncate text-slate-200">
                              <span className="inline-flex items-center rounded-full bg-sky-500/20 text-sky-300 px-2 py-0.5 mr-1">
                                {s.appid}
                              </span>
                              <span className="truncate inline-block align-middle max-w-[8rem]">
                                {s.game_name || "未知游戏"}
                              </span>
                            </div>
                            <div className="text-cyan-300 font-semibold">
                              +{s.minutes_delta}
                            </div>
                          </div>
                          <div className="mt-1 text-[10px] text-slate-400">
                            {start.toLocaleString()} →{" "}
                            {end.toLocaleTimeString()}
                          </div>
                        </div>
                      );
                    })}
                    {!sessions.length && (
                      <p className="text-xs text-slate-500">
                        暂无数据，可等待后端累积更多快照。
                      </p>
                    )}
                  </div>
                </div>
              </div>
            </div>
          </section>
        );
      }

      function App() {
        const [users, setUsers] = useState([]);
        const [activeUser, setActiveUser] = useState(null);
        const [sessionsByUser, setSessionsByUser] = useState({});
        const [loading, setLoading] = useState(false);
        const [error, setError] = useState(null);
        const scrolled = useScrollNav();

        useEffect(() => {
          (async () => {
            try {
              const data = await fetchJson("/api/users");
              setUsers(data);
              const urlParams = new URLSearchParams(window.location.search);
              const fromUrl = urlParams.get("steamid");
              const initial =
                data.find((u) => u.steamid === fromUrl)?.steamid ||
                (data[0] && data[0].steamid) ||
                null;
              if (initial) setActiveUser(initial);
            } catch (e) {
              console.error(e);
              setError("无法加载用户列表，请检查后端和数据库。");
            }
          })();
        }, []);

        useEffect(() => {
          if (!activeUser) return;
          if (sessionsByUser[activeUser]) return;
          setLoading(true);
          setError(null);
          fetchJson("/api/sessions", { steamid: activeUser })
            .then((data) => {
              const sorted = data
                .slice()
                .sort(
                  (a, b) =>
                    new Date(a.window_start_utc) -
                    new Date(b.window_start_utc)
                );
              setSessionsByUser((prev) => ({ ...prev, [activeUser]: sorted }));
            })
            .catch((e) => {
              console.error(e);
              setError("加载会话数据失败。");
            })
            .finally(() => setLoading(false));
        }, [activeUser, sessionsByUser]);

        return (
          <div className="min-h-screen text-slate-100">
            <header
              className={`fixed inset-x-0 top-0 z-30 transition-all ${
                scrolled
                  ? "glass-nav"
                  : "bg-gradient-to-b from-slate-950/90 to-transparent"
              }`}
            >
              <div className="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <div className="h-7 w-7 rounded-xl bg-gradient-to-tr from-violet-500 via-sky-400 to-emerald-300 shadow-lg shadow-sky-500/40" />
                  <div>
                    <div className="text-[11px] font-semibold tracking-wide text-slate-200">
                      Steam Playtime Radar
                    </div>
                    <div className="text-[10px] text-slate-400">
                      隐身场景下的游玩时间区间推断
                    </div>
                  </div>
                </div>
                <div className="hidden md:flex items-center gap-4 text-[10px] text-slate-400">
                  <span>基于 Steam Web API</span>
                  <span>只读分析，无账号风险</span>
                </div>
              </div>
            </header>

            <main className="pt-16 space-y-16 md:space-y-24">
              <section className="py-10 md:py-14">
                <div className="max-w-6xl mx-auto px-4 grid md:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)] gap-8 items-center">
                  <div>
                    <p className="text-[11px] font-semibold text-cyan-300 mb-2">
                      Steam 隐身模式行为分析
                    </p>
                    <h1 className="text-2xl md:text-4xl font-semibold text-slate-50 leading-snug">
                      用 <span className="text-cyan-300">时长增量</span> 推断
                      <span className="text-sky-300">
                        {" "}
                        可能的游玩时间区间
                      </span>
                      。
                    </h1>
                    <p className="mt-3 text-sm text-slate-400 max-w-xl">
                      后端定期调用{" "}
                      <span className="font-mono text-xs text-sky-300">
                        IPlayerService / GetOwnedGames
                      </span>{" "}
                      记录所有游戏的总时长快照。当某个游戏的总时长跳变时，就在前后两次快照之间生成一段
                      session。
                    </p>
                    <div className="mt-6 flex flex-wrap gap-3 items-center">
                      <MagneticButton>浏览所有玩家的推断轨迹</MagneticButton>
                      <p className="text-[11px] text-slate-500 max-w-xs">
                        向下滚动，按不同玩家切换标签，每个玩家都有独立的图表和最近 session 列表。
                      </p>
                    </div>
                  </div>

                  <div
                    className="relative h-52 md:h-60"
                  >
                    <div className="absolute inset-0 bg-gradient-to-br from-sky-500/30 via-violet-500/20 to-emerald-400/25 rounded-3xl blur-3xl" />
                    <div className="relative h-full rounded-3xl border border-slate-700/70 bg-slate-950/80 backdrop-blur-xl overflow-hidden shadow-xl shadow-sky-500/40">
                      <div className="px-4 pt-3 pb-2 flex items-center justify-between border-b border-slate-800/80">
                        <div className="flex items-center gap-2">
                          <span className="h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span>
                          <span className="text-[11px] text-slate-300">
                            快照采集流
                          </span>
                        </div>
                        <span className="text-[10px] text-slate-500">
                          间隔由后端配置
                        </span>
                      </div>
                      <div className="p-4 flex flex-col gap-2 text-[11px]">
                        <div className="flex items-center justify-between text-slate-300">
                          <span>某游戏总时长</span>
                          <span className="font-mono text-sky-300">
                            2040 → 2100
                          </span>
                        </div>
                        <div className="grid grid-cols-3 gap-2 mt-1">
                          <div className="h-16 rounded-xl bg-slate-900/80 border border-sky-500/40 flex flex-col justify-between p-2">
                            <div className="text-[10px] text-slate-400">
                              Δplaytime
                            </div>
                            <div className="font-mono text-xs text-sky-300">
                              +60 分钟
                            </div>
                            <div className="text-[10px] text-slate-500">
                              作为潜在 session
                            </div>
                          </div>
                          <div className="h-16 rounded-xl bg-slate-900/80 border border-violet-500/40 flex flex-col justify-between p-2">
                            <div className="text-[10px] text-slate-400">
                              时间窗口
                            </div>
                            <div className="font-mono text-[10px] text-violet-200">
                              [T₀, T₁]
                            </div>
                            <div className="text-[10px] text-slate-500">
                              精度取决于轮询 + Steam 刷新
                            </div>
                          </div>
                          <div className="h-16 rounded-xl bg-slate-900/80 border border-cyan-500/40 flex flex-col justify-between p-2">
                            <div className="text-[10px] text-slate-400">
                              前端展示
                            </div>
                            <div className="font-mono text-xs text-cyan-200">
                              图表 + 列表
                            </div>
                            <div className="text-[10px] text-slate-500">
                              不做额外推理
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>

              <section className="py-6 border-t border-slate-800/60 bg-slate-950/60">
                <div className="max-w-6xl mx-auto px-4">
                  <div className="flex flex-wrap items-center justify-between gap-3 mb-3">
                    <h2 className="text-sm font-medium text-slate-200">
                      已采集到的玩家
                    </h2>
                    <p className="text-[11px] text-slate-500">
                      基于 PG 数据库中 <code>playtime_snapshots</code> 表的去重
                      SteamID。
                    </p>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {users.map((u) => {
                      const active = activeUser === u.steamid;
                      return (
                        <button
                          key={u.steamid}
                          onClick={() => setActiveUser(u.steamid)}
                          className={`text-[11px] px-3 py-1 rounded-full border ${
                            active
                              ? "bg-sky-500/20 border-sky-400 text-sky-100"
                              : "bg-slate-900/80 border-slate-700 text-slate-300 hover:border-slate-500"
                          } transition-colors`}
                        >
                          {u.steamid}
                        </button>
                      );
                    })}
                    {!users.length && (
                      <span className="text-[11px] text-slate-500">
                        暂无玩家，请先让后端采集脚本跑一阵。
                      </span>
                    )}
                  </div>
                </div>
              </section>

              <section className="pb-16">
                <div className="max-w-6xl mx-auto px-4">
                  {error && (
                    <div className="mb-4 text-xs text-rose-400 bg-rose-950/40 border border-rose-700/60 rounded-xl px-3 py-2">
                      {error}
                    </div>
                  )}
                  {loading && (
                    <div className="mb-4 text-xs text-slate-400">
                      正在加载 {activeUser} 的 session 数据…
                    </div>
                  )}
                  {activeUser && sessionsByUser[activeUser] && (
                    <UserSection
                      steamid={activeUser}
                      sessions={sessionsByUser[activeUser]}
                    />
                  )}
                  {!activeUser && !error && (
                    <p className="text-sm text-slate-400">
                      请选择上方的某个玩家标签查看图表。
                    </p>
                  )}
                </div>
              </section>
            </main>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
